<div role="tablist" class="tabs tabs-border">
    <a role="tab" class="tab tab-active" (click)="goToPage('/zw/competition-results')">GENERAL RANKING</a>
    <a role="tab" class="tab" (click)="goToPage('/zw/stage-results')">STAGE RANKING</a>
</div>

<!-- <div role="tablist" class="tabs tabs-border">
    <a role="tab" class="tab tab-active" (click)="goToPage('/zw/competition-results')">TIME Classification</a>
    <a role="tab" class="tab" (click)="goToPageJersey('/zw/competition-points')">JERSEY Classification</a>
</div> -->


<div class="p-4">
    @if (loading()) {
        <!-- Skeleton loading -->
        <div class="flex gap-4">
            <div class="skeleton h-24 w-24 rounded"></div>
            <div class="flex-1 space-y-3">
                <div class="skeleton h-6 w-1/3"></div>
                <div class="skeleton h-4 w-1/2"></div>
                <div class="skeleton h-4 w-2/3"></div>
            </div>
        </div>
    } @else if (error()) {
        <div class="text-red-600">{{ error() }}</div>
    } @else {

        <h2 class="text-xl hover:underline hover:text-primary font-bold cursor-pointer" (click)="goToPage('/game/competition')">
            {{ competitionInfos()?.competitionName }}
        </h2>

        @if (results(); as data) {

            @if (stageNumber() > 0 && stageNumber() < data.lastStageNumber) {
                <p class="text-sm opacity-60 mb-2">
                    Rankings after stage {{ stageNumber() }}
                </p>
            }

            <!-- Navigation Stages -->
            <div class="flex gap-2 items-center mb-3">
                @if (stageNumber() === 0 && data.lastStageNumber > 0){
                    <button
                            class="btn btn-ghost btn-sm"
                            (click)="goToStage(1)"
                        >
                            > Rankings after stages
                    </button>
                }
                @if (stageNumber() >= 1){
                    <button
                        class="btn btn-ghost btn-sm"
                        [disabled]="stageNumber() == 1"
                        (click)="goToStage(stageNumber() - 1)"
                    >
                        <
                    </button>
                    <span class="px-2 text-sm">
                        Stage {{ stageNumber() }} / {{ data.lastStageNumber }}
                    </span>

                    <button
                        class="btn btn-ghost btn-sm"
                        [disabled]="stageNumber() >= data.lastStageNumber"
                        (click)="goToStage(stageNumber() + 1)"
                    >
                        >
                    </button>
                }
            </div>

            <!-- Boutons Catégories -->
            <div class="flex gap-2 mb-4">
                @for (cat of ['A','B','C','D','E']; track cat) {
                    <button
                    class="btn btn-sm transition-all duration-150"
                    [class.btn-ghost]="cat !== category()"

                    [style.--btn-color]="cat === category()
                        ? (cat === 'A' ? '#dc2626'
                        : cat === 'B' ? '#22c55e'
                        : cat === 'C' ? '#06b6d4'
                        : cat === 'D' ? '#facc15'
                        : '#831843')
                        : null"

                    [ngClass]="{
                        'text-white': cat === category() && cat !== 'D',
                        'text-black': cat === category() && cat === 'D'
                    }"
                    (click)="goToCategory(cat)"
                    >
                    {{ cat }}
                    </button>
                }
            </div>


            <div class="overflow-auto">
                <table class="table w-full table-zebra border border-base-300">
                    <thead>
                        <tr class="bg-base-200 text-sm">
                            <th>#</th>
                            <th>Rider</th>
                            <th class="text-right">Gap</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (data?.results?.length) {
                            @for (rider of data.results; track rider.gcRank; let i = $index) {
                                
                                <!-- Ligne de séparation GC -->
                                @if (rider.isTimeDisabled && !data.results[i - 1]?.isTimeDisabled) {
                                    <tr>
                                        <td colspan="7" class="text-xs text-center text-gray-500 bg-base-200">
                                            <span-lucide [img]="TimerOffIcon" [size]="16" class="inline-block cursor-help" title="Time-Neutral"></span-lucide>
                                            Time-neutral threshold 
                                            @if (competitionInfos()?.showTimeThreshold) {
                                                <span class="pe-1">{{ competitionInfos()?.timeNeutralLimit | duration }}</span>
                                            }
                                            <span>– Riders below do not count toward the next cGap base</span>
                                        </td>
                                    </tr>
                                }

                                <!-- Ligne du coureur -->
                                <tr [ngClass]="{ 'opacity-50 italic': rider.isTimeDisabled }">
                                    <td>{{ rider.gcRank }}</td>
                                    <td>
                                        @if (rider.flag) {
                                            <img
                                                class="inline h-4 w-5 me-2"
                                                [src]="'assets/flags/4x3/' + rider.flag + '.svg'"
                                                [attr.alt]="rider.flag"
                                            />
                                        }
                                        <span 
                                        (click)="goToZwiftPovwer(rider.zwiftId)"
                                        class="hover:underline hover:text-primary cursor-pointer" [innerHTML]="rider.racerName"></span>
                                    </td>
                                    <td class="text-right font-medium">
                                        <span class="tooltip" [attr.data-tip]="rider.cGapGC | duration:true">
                                            {{ rider.cGapGC | duration }}
                                        </span>                                    
                                    </td>
                                    <td>{{ rider.slotNumber }}</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        } @else {
            <div class="text-gray-500 mt-4">No results available.</div>
        }
    }
</div>
