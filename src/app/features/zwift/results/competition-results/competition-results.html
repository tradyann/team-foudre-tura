<div class="mb-6">
  <a
    [routerLink]="['/game/competition', competitionId()]"
    class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-widest hover:opacity-80 transition"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Retour
  </a>
</div>


<div role="tablist" class="tabs tabs-border bg-base-100">
    <a role="tab" class="tab tab-active font-bold px-8 uppercase text-primary" (click)="goToPage('/zw/competition-results')">GENERAL RANKING</a>
    <a role="tab" class="tab px-8 opacity-60 hover:opacity-100 uppercase font-bold" (click)="goToPage('/zw/stage-results')">STAGE RANKING</a>
</div>

<div class="p-4 w-full text-base-content">
    @if (loading()) {
        <div class="flex gap-4">
            <div class="skeleton h-24 w-24 rounded"></div>
            <div class="flex-1 space-y-3">
                <div class="skeleton h-6 w-1/3"></div>
                <div class="skeleton h-4 w-1/2"></div>
            </div>
        </div>
    } @else if (error()) {
        <div class="text-red-600 font-bold underline">{{ error() }}</div>
    } @else {

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h2 class="text-xl hover:underline hover:text-primary font-bold cursor-pointer uppercase tracking-tight italic" (click)="goToPage('/game/competition')">
                    {{ competitionInfos()?.competitionName }}
                </h2>
                
                @if (results(); as data) {
                    <div class="flex items-center gap-4 mt-3">
                        <div class="join border border-base-300 shadow-sm bg-base-200 rounded-lg overflow-hidden font-bold">
                            <button class="join-item btn btn-ghost btn-xs px-3" 
                                    [disabled]="stageNumber() <= 1"
                                    (click)="goToStage(stageNumber() - 1)"> < </button>
                            
                            <div class="join-item px-4 flex items-center bg-base-100 text-[11px] uppercase tracking-widest">
                                Stage {{ stageNumber() }} / {{ data.lastStageNumber }}
                            </div>

                            <button class="join-item btn btn-ghost btn-xs px-3"
                                    [disabled]="stageNumber() >= data.lastStageNumber"
                                    (click)="goToStage(stageNumber() + 1)"> > </button>
                        </div>
                    </div>
                }
            </div>

            <div class="flex flex-wrap gap-1 p-1 bg-base-200 rounded-xl border border-base-300 shadow-inner">
                @for (cat of ['A','B','C','D','E','F','G','H','I','J']; track cat; let i = $index) {
                    <button
                        class="btn btn-outline btn-sm min-w-[45px] transition-all"
                        [style.background-color]="cat === category() 
                            ? '#3abdf7'
                            : 'transparent'"
                        (click)="goToCategory(cat)"
                    >
                        {{ i + 1 }}
                    </button>
                }
            </div>
        </div>

        @if (results(); as data) {

            @if (stageNumber() > 0 && stageNumber() < data.lastStageNumber) {
                <p class="text-[10px] opacity-60 mb-3 font-black uppercase tracking-[0.15em] italic border-l-4 border-primary pl-3">
                    General Classification after stage {{ stageNumber() }}
                </p>
            }

            <div class="overflow-auto rounded-xl border border-base-300 shadow-sm">
                <table class="table w-full table-zebra">
                    <thead>
                        <tr class="bg-base-200 text-xs uppercase tracking-widest opacity-60 font-bold">
                            <th class="w-16">#</th>
                            <th>Rider</th>
                            <th class="text-right">Gap (Total)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (data?.results?.length) {
                            @for (rider of data.results; track rider.gcRank; let i = $index) {
                                
                                @if (rider.isTimeDisabled && !data.results[i - 1]?.isTimeDisabled) {
                                    <tr>
                                        <td colspan="3" class="text-[10px] text-center font-bold text-base-content/50 bg-base-200/50 p-2 uppercase tracking-tighter italic border-y border-base-300">
                                            Time-neutral threshold 
                                            @if (competitionInfos()?.showTimeThreshold) {
                                                <span class="px-1 text-primary font-black">{{ competitionInfos()?.timeNeutralLimit | duration }}</span>
                                            }
                                            <span class="opacity-70">— Neutral zone for GC base</span>
                                        </td>
                                    </tr>
                                }

                                <tr [ngClass]="{ 'opacity-40 grayscale italic': rider.isTimeDisabled }" class="hover:bg-base-200/40 transition-colors">
                                    <td class="font-black italic text-lg text-base-content/20">{{ rider.gcRank }}</td>
                                    <td>
                                        <div class="flex items-center gap-2">

                                            @if (rider.flag) {
                                                <img class="h-3.5 w-5 rounded-sm shadow-sm" [src]="'assets/flags/4x3/' + rider.flag + '.svg'" />
                                            }
                                            <span 
                                                (click)="goToZwiftPovwer(rider.zwiftId)"
                                                [ngClass]="{ 'opacity-40 grayscale italic': !rider.checkWeight || !rider.checkTrainer }"
                                                class="hover:underline hover:text-primary cursor-pointer font-bold" 
                                                [innerHTML]="rider.racerName">
                                            </span>

                                            @if(!rider.checkWeight) {
                                                <span class="text-xs bg-error/10 text-error px-1 rounded-sm cursor-pointer"
                                                [routerLink]="['/zw/identification']">Poids à vérfier ></span>
                                            }
                                            @if(!rider.checkTrainer) {
                                                <span class="text-xs bg-error/10 text-error px-1 rounded-sm cursor-pointer"
                                                [routerLink]="['/zw/identification']">HT à vérifier ></span>
                                            }
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <div class="tooltip tooltip-left font-black text-sm text-base-content" [attr.data-tip]="rider.cGapGC | duration:true">
                                            {{ rider.cGapGC | duration }}
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        } @else {
            <div class="text-gray-500 mt-4 italic p-8 text-center border-2 border-dashed border-base-300 rounded-xl uppercase font-bold text-xs opacity-50 tracking-widest">
                No results available for this ranking.
            </div>
        }
    }
</div>