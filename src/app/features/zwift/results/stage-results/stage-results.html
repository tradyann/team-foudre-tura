<div class="mb-6">
  <a
    [routerLink]="['/game/competition', competitionId()]"
    class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-widest hover:opacity-80 transition"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Retour
  </a>
</div>


<div role="tablist" class="tabs tabs-border bg-base-100">
    <a role="tab" class="tab px-8 opacity-60 hover:opacity-100 uppercase font-bold" (click)="goToPage('/zw/competition-results')">GENERAL RANKING</a>
    <a role="tab" class="tab tab-active px-8 uppercase font-bold text-primary" (click)="goToPage('/zw/stage-results')">STAGE RANKING</a>
</div>

<div class="p-4 w-full">
    @if (loading()) {
        <div class="flex gap-4">
            <div class="skeleton h-24 w-24 rounded"></div>
            <div class="flex-1 space-y-3">
                <div class="skeleton h-6 w-1/3"></div>
                <div class="skeleton h-4 w-1/2"></div>
                <div class="skeleton h-4 w-2/3"></div>
            </div>
        </div>
    } @else if (error()) {
        <div class="text-red-600 font-bold underline">{{ error() }}</div>
    } @else {

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h2 class="text-xl hover:underline hover:text-primary font-bold cursor-pointer uppercase tracking-tight" (click)="goToPage('/game/competition')">
                    {{ stageInfos()?.competitionName }}
                </h2>
                <h3 class="text-sm opacity-60 font-medium italic mt-0.5">{{ stageInfos()?.routeName }}</h3>
                
                <div class="flex items-center gap-4 mt-3">
                    <div class="join border border-base-300 shadow-sm bg-base-200 rounded-lg overflow-hidden">
                        <button class="join-item btn btn-ghost btn-xs px-3" 
                                [disabled]="stageNumber() === 1"
                                (click)="goPrev()"> < </button>
                        
                        <div class="join-item px-4 flex items-center bg-base-100 text-[11px] font-bold uppercase tracking-widest text-base-content/80">
                            Stage {{ stageInfos()?.stageNumber }} / {{ stageInfos()?.lastStageNumber || '?' }}
                        </div>

                        <button class="join-item btn btn-ghost btn-xs px-3"
                                [disabled]="stageNumber() >= stageInfos()?.lastStageNumber"
                                (click)="goNext()"> > </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-1 p-1 bg-base-200 rounded-xl border border-base-300">
                @for (cat of ['A','B','C','D','E','F','G','H','I','J']; track cat; let i = $index) {
                    <button
                        class="btn btn-outline btn-sm min-w-[45px] transition-all"
                        [style.background-color]="cat === category() 
                            ? '#3abdf7'
                            : 'transparent'"
                        (click)="goToCategory(cat)"
                    >
                        {{ i + 1 }}
                    </button>
                }
            </div>
        </div>

        @if (results(); as data) {
            <div class="overflow-auto rounded-lg border border-base-300 shadow-sm">
                <table class="table w-full table-zebra">
                <thead>
                    <tr class="bg-base-200 text-sm">
                        <th>#</th>
                        <th>Rider</th>
                        <th class="text-right">Gap</th>
                        <th class="text-right">Bonus</th>
                        <th class="text-right font-bold">GapNet</th>
                        <th class="text-right w-16">
                            <button class="btn btn-outline btn-xs sm:btn-sm" (click)="toggleSlotSort()" title="Filter Present/Missed">
                                @if (sortBySlot()) {
                                    <span>✓</span>
                                } @else {
                                    <span>✖</span>
                                }
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if (data?.results?.length) {
                    @for (rider of displayedResults(); track rider.rowNumber) {
                        <tr [ngClass]="{'opacity-40 grayscale' : rider.isMissed}" class="hover:bg-base-200/50 transition-colors">
                            <td class="font-bold">@if (!rider.isMissed) { <span>{{ rider.rowNumber }}</span> }</td>
                            <td>
                                <div class="flex items-center">
                                    @if (rider.flag) {
                                    <img
                                        class="inline h-4 w-5 me-2 rounded-sm shadow-sm"
                                        [src]="'assets/flags/4x3/' + rider.flag + '.svg'"
                                        [attr.alt]="rider.flag"
                                    />
                                    }
                                    <span 
                                        (click)="goToZwiftPovwer(rider.zwiftId)"
                                        class="hover:underline hover:text-primary cursor-pointer font-medium"
                                        [innerHTML]="rider.racerName"
                                        >
                                    </span>
                                </div>
                            </td>
                            <td class="text-right font-mono">
                                @if(rider.rowNumber === 1 && rider.wasTimeNeutral) {
                                    <span-lucide [img]="TimerOffIcon" [size]="16" class="inline-block align-middle text-warning" title="Time-Neutral"></span-lucide>
                                } @else {
                                    <span class="tooltip" [attr.data-tip]="rider.eGap | duration:true">
                                        {{ rider.eGap | duration }}
                                    </span>
                                }
                            </td>
                            <td class="text-right font-medium">
                                @if(rider.bonusTime !== null && rider.bonusTime !== 0) {
                                    -{{ rider.bonusTime | number: '1.0-1' }}s
                                }
                            </td>
                            <td class="text-right font-black">
                                <span class="tooltip" [attr.data-tip]="rider.cGapNet | duration:true">
                                    {{ rider.cGapNet | duration }}
                                </span>
                            </td>
                            <td class="text-center font-bold opacity-60">
                                @if (!rider.isMissed) { <span>{{ rider.slotNumber }}</span> } @else { <span class="text-error text-xs uppercase">Missed</span> }
                            </td>
                        </tr>
                    }
                    }
                </tbody>
                </table>
            </div>
        } @else {
            <div class="text-gray-500 mt-4 italic bg-base-200 p-8 rounded-lg text-center border-2 border-dashed border-base-300">
                No results available for this stage.
            </div>
        }
    }
</div>