<div class="p-4">
    @if (loading()) {
        <!-- Skeleton loading -->
        <div class="flex gap-4">
            <div class="skeleton h-24 w-24 rounded"></div>
            <div class="flex-1 space-y-3">
                <div class="skeleton h-6 w-1/3"></div>
                <div class="skeleton h-4 w-1/2"></div>
                <div class="skeleton h-4 w-2/3"></div>
            </div>
        </div>
    } @else if (error()) {
        <div role="alert" class="alert alert-soft alert-error mt-2">
            <span>{{ error() }}</span>
        </div>
    } @else {

        <h2 class="text-xl font-bold mb-3">{{ competition()?.competitionName }}</h2>
        <div class="opacity-60">{{ competition()?.fromDate | date: 'EEE, MMM d' }} - {{ competition()?.toDate | date: 'EEE, MMM d' }}</div>

        @if (competition()?.competCategory) {
            <div role="alert" class="alert alert-soft my-3">
                <span>You must join this competition in the category:</span>
                <span class="badge badge-ghost me-1"
                    [ngClass]="{
                        'bg-red-600 text-white': competition()?.competCategory === 'A',
                        'bg-green-500 text-white': competition()?.competCategory === 'B',
                        'bg-cyan-500 text-white': competition()?.competCategory === 'C',
                        'bg-yellow-400 text-white': competition()?.competCategory === 'D',
                        'bg-pink-900 text-white': competition()?.competCategory === 'E',
                        }"
                    >
                        {{competition()?.competCategory }}
                </span>
            </div>
        } @else if (competition()!.idClient > 0) {
            <div role="alert" class="alert alert-soft alert-error my-3">
                You must link your <a class="text-primary ms-1 hover:underline" [routerLink]="['/account/zwift-linked']">Zwift account here</a>
            </div>
        }

        <div class="overflow-x-auto">
            <table class="table table-zebra w-full border border-base-300">
                <thead>
                    <tr class="bg-base-200 text-xs uppercase">
                        <th>STAGE</th>
                        <th>DATE</th>
                        <th>TYPE</th>
                        <th>FORMAT</th>
                        <th>ROUTE</th>
                        <th></th>
                    </tr>
                </thead>
                            <tbody>
                            @for (t of results(); track t.stageId) {
                                <tr>
                                    <!-- Stages -->
                                    <td>{{ t.stageNumber }}</td>
                                    <td>{{ t.stageDate | date: 'EEE, MMM d' }}</td>
                                    <td>{{ t.raceTypeName }} </td>
                                    <td>
                                        @for (d of  t.divisionStructure; track d.id) {
                                            <span class="badge badge-ghost text-white me-1"
                                                [ngClass]="{
                                                    'bg-red-600': d.cat === 'A',
                                                    'bg-green-500': d.cat === 'B',
                                                    'bg-cyan-500': d.cat === 'C',
                                                    'bg-yellow-400': d.cat === 'D',
                                                    'bg-pink-900': d.cat === 'E',
                                                    }"
                                                >
                                                {{ d.cat }}
                                            </span>
                                        }
                                        <div>{{ t.roadbook.raceFormatName }}</div>
                                    </td>
                                    <td>
                                        <a [href]=t.roadbook.links class="font-medium hover:underline" target="_blank">{{ t.roadbook.routeName }}</a>    
                                        @if (t.roadbook.laps) {  <div>{{ t.roadbook.laps }} {{ t.roadbook.laps > 1 ? 'laps' : 'lap' }}</div>  }
                                        @if (t.roadbook.distanceInMeters) {  <div>{{ t.roadbook.distanceInMeters / 1000 }} km</div> }
                                        @if (t.roadbook.durationInSeconds) {  <div>{{ t.roadbook.durationInSeconds / 60 }} mn</div>  }
                                        <a [routerLink]="['/game/roadbook', t.roadbook.roadbookId]" class="text-primary ms-1 hover:underline ">[roadbook]</a>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-xs" (click)="goToResults(t.stageNumber)">Results</button>
                                    </td>
                                </tr>
                            }
                            </tbody> 

            </table>
        </div>
        
        @if(competition()?.isClosed) {
            <a (click)="goToClassification()"
                class="text-primary font-medium hover:underline flex items-center gap-1 cursor-pointer">
                <span-lucide [img]="TrophyIcon" class="size-4"></span-lucide>
                <span>Final Classification</span>
            </a>
        } @else {
            <a (click)="goToClassification()"
                class="text-primary font-medium hover:underline flex items-center gap-1 cursor-pointer">
                <span>Classification</span>
            </a>
        }
        
        <div class="text-sm opacity-80">Total: <span class="font-bold">{{ competition()?.stagesCount }} {{ competition()!.stagesCount > 1 ? 'stages': 'stage' }}</span></div>

        @if(competition()?.timeNeutralLimit && competition()!.timeNeutralLimit < 99999) {
            <div class="text-sm opacity-80">Time Neutral: <span class="font-bold">{{ competition()?.timeNeutralLimit | duration}} mn</span></div>
        }
    }
</div>
