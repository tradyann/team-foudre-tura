<div class="p-4 w-full"> @if (loading()) {
        <div class="flex gap-4">
            <div class="skeleton h-24 w-24 rounded"></div>
            <div class="flex-1 space-y-3">
                <div class="skeleton h-6 w-1/3"></div>
                <div class="skeleton h-4 w-1/2"></div>
            </div>
        </div>
    } @else if (error()) {
        <div role="alert" class="alert alert-soft alert-error mt-2">
            <span>{{ error() }}</span>
        </div>
    } @else {
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
                <h2 class="text-2xl font-black tracking-tighter uppercase italic">
                    {{ competition()?.competitionName }}
                </h2>
                <div class="text-sm opacity-60 font-medium">
                    {{ competition()?.fromDate | date: 'EEE, MMM d' }} — {{ competition()?.toDate | date: 'EEE, MMM d' }}
                </div>
            </div>

            <button (click)="goToClassification()" 
                class="btn btn-primary shadow-md flex items-center gap-2 group">
                <span-lucide [img]="TrophyIcon" class="size-4"></span-lucide>
                <span>{{ competition()?.isClosed ? 'Final Classification' : 'Classification' }}</span>
            </button>
        </div>

        @if (competition()?.competCategory) {
            <div class="flex items-center gap-3 bg-base-200/50 p-3 rounded-lg mb-6 border border-base-300">
                <span class="text-xs font-bold opacity-70 uppercase tracking-wider">Required Category:</span>
                <span class="badge font-black text-white border-none shadow-sm"
                    [ngClass]="{
                        'bg-red-600': competition()?.competCategory === 'A',
                        'bg-green-500': competition()?.competCategory === 'B',
                        'bg-cyan-500': competition()?.competCategory === 'C',
                        'bg-yellow-400': competition()?.competCategory === 'D',
                        'bg-pink-900': competition()?.competCategory === 'E'
                    }">
                    {{ competition()?.competCategory }}
                </span>
            </div>
        } @else if (competition()!.idClient > 0) {
            <div role="alert" class="alert alert-soft alert-error my-4">
                <span>You must link your <a class="text-primary font-bold hover:underline" [routerLink]="['/account/zwift-linked']">Zwift account here</a></span>
            </div>
        }

        <div class="overflow-x-auto">
            <table class="table table-zebra w-full border-t border-base-300">
                <thead>
                    <tr class="text-xs uppercase opacity-50 tracking-widest">
                        <th>Stage</th>
                        <th>Date</th>
                        <th>Format</th>
                        <th>Type</th>
                        <th>Route</th>
                        <th class="text-right">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @for (t of results(); track t.stageId) {
                        <tr class="hover:bg-base-200/50 transition-colors">
                            <td class="font-black text-lg opacity-40 italic">{{ t.stageNumber }}</td>
                            <td class="font-medium whitespace-nowrap">{{ t.stageDate | date: 'EEE, MMM d' }}</td>
                            <td>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <!-- @for (d of t.divisionStructure; track d.id) {
                                        @if(d.cat !== 'E') {
                                            <span class="px-1 rounded text-[10px] font-bold text-white shadow-sm"
                                            [ngClass]="{
                                                'bg-red-600': d.cat === 'A',
                                                'bg-green-500': d.cat === 'B',
                                                'bg-cyan-500': d.cat === 'C',
                                                'bg-yellow-400': d.cat === 'D',
                                                'bg-pink-900': d.cat === 'E'
                                            }">{{ d.cat }}</span>
                                        }
                                    } -->
                                </div>
                                <div class="text-[11px] font-bold opacity-70 uppercase">{{ t.roadbook.raceFormatName }} </div>
                            </td>
                            <td>{{ t.raceTypeName }} </td>
                            <td>
                                <div class="font-bold text-base-content">{{ t.roadbook.routeName }}</div>
                                <div class="text-[10px] opacity-60 flex gap-2 font-bold uppercase">
                                    @if (t.roadbook.laps) { 
                                        <span>{{ t.roadbook.laps }} {{ t.roadbook.laps > 1 ? 'LAPS' : 'LAP' }}</span> 
                                    }
                                    @if (t.roadbook.distanceInMeters) { <span>{{ t.roadbook.distanceInMeters / 1000 }} KM</span> }
                                    @if (t.roadbook.durationInSeconds) { <span>{{ t.roadbook.durationInSeconds / 60 }} MIN</span> }
                                </div>
                                <a [routerLink]="['/game/roadbook', t.roadbook.roadbookId]" 
                                   class="text-[10px] text-primary hover:underline font-bold mt-1 inline-block">
                                   ROADBOOK →
                                </a>
                            </td>
                            <td class="text-right">
                                <button class="btn btn-primary btn-xs sm:btn-sm" (click)="goToResults(t.stageNumber)">
                                    Results
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="flex gap-4 mt-6 pt-4 border-t border-base-200 text-[10px] font-black opacity-50 uppercase tracking-widest">
            <div>Total: {{ competition()?.stagesCount }} {{ competition()!.stagesCount > 1 ? 'stages': 'stage' }}</div>
            @if(competition()?.timeNeutralLimit && competition()!.timeNeutralLimit < 99999) {
                <div>Neutral: {{ competition()?.timeNeutralLimit | duration }}</div>
            }
        </div>
    }
</div>